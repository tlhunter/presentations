<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atomicity in Redis by @tlhunter</title>
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">
    <link rel="stylesheet" href="lib/css/hybrid.css">
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName('head')[0].appendChild(link);
    </script>
<style>
:root {
  --zeta: #0E0E0E;
  --alpha: #0E0E0E;
  --beta: #263A3E;
  --gamma: #6A848B;
  --delta: #B6D2D7;
  --epsilon: #F4F2F2;
  --omega: #BEB6A9;
  --theta: #6A848B;
}
body {
  background-color: var(--alpha);
}

.reveal pre {
  font-size: 0.7em;
  width: 100%;
  box-shadow: none;
  background-color: var(--zeta);
  padding: 1em;
}
.reveal pre .nl {
  color: var(--epsilon);
}
.reveal pre code {
  max-height: 500px;
  padding: 0px;
}
.reveal p code,
.reveal li code {
  background-color: var(--epsilon);
  border-radius: 8px;
  color: var(--beta);
  padding: 2px 10px;
}
.reveal li code,
.reveal p code,
.reveal h3 code {
  font-size: 0.8em;
}
.reveal li code a {
  color: var(--beta);
}

.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
  text-transform: initial;
}
.reveal h1,
.reveal h2,
.reveal h3,
.attention {
  color: var(--epsilon);
  text-shadow: 0px 1px 5px var(--zeta);
}
.reveal h3 {
  color: var(--gamma);
}

.reveal section img {
  border: none;
  background: none;
  box-shadow: none;
}
.reveal blockquote {
  text-align: left;
  width: auto;
}
.reveal blockquote .author {
  text-align: right;
}
.reveal a {
  color: var(--omega);
}
.reveal a:hover {
  color: var(--theta);
}
.reveal pre .highlight {
  color: var(--delta);
}

.reveal .progress span {
  background-color: var(--delta);
}
.reveal .controls {
  color: var(--gamma);
}

#twitter {
  left: 20px;
}
#website {
  right: 20px;
}
.floater {
  position: absolute;
  bottom: 20px;
  font-size: 3em;
  z-index: 1;
}
.floater, .floater a {
  color: var(--gamma);
  text-decoration: none;
  font-family: "Source Sans Pro", Helvetica, sans-serif;
  font-weight: 600;
  text-shadow: 0px 1px 5px var(--zeta);
}
</style>
  </head>
  <body>
    <div id="twitter" class="floater"><a href="https://twitter.com/tlhunter">@tlhunter</a></div>
    <div id="website" class="floater"><a href="https://intrinsic.com">intrinsic.com</a></div>

    <div class="reveal">
      <div class="slides">

        <section class="intro">
          <h2>Atomicity in Redis<br /><small>(with examples in Node.js)</small></h2>
          <h3>Thomas Hunter II</h3>

          <!-- <img src="./images/intrinsic.svg" width="35%" style="background: transparent; box-shadow: none;" /> -->
        </section>


        <section>
          <h2>Roadmap</h2>

          <ol>
            <li><a href="#/chapter-1">Single-Command Atomicity</a></li>
            <li><a href="#/chapter-2">Pipelining</a></li>
            <li><a href="#/chapter-3">Multi</a></li>
            <li><a href="#/chapter-4">Lua Scripting</a></li>
          </ol>
        </section>


        <section>
          <h3>Background</h3>

          <ul>
            <li>Redis is Mostly Single-Threaded
              <ul>
                <li>Except for things like Background IO</li>
              </ul>
            </li>
            <li>Node.js is Mostly Single-Threaded
              <ul>
                <li>Except for IO and Node v10 Worker Threads</li>
              </ul>
            </li>
            <li>Atomicity:
              <ul>
                <li>Complex operations happen uninterupted</li>
              </ul>
            </li>
            <li>This becomes a problem with multiple clients</li>
          </ul>
        </section>


        <section id="chapter-1">
          <h2>Single-Command Atomicity</h2>
        </section>


        <section>
          <h3>Every <em>Single</em> Command is Atomic</h3>

          <pre><code class="ini">GET foo

SET foo 1

DEL foo

FLUSHALL</code></pre>
        </section>


        <section id="interleaving-0">
          <h3><em>Multiple</em> Commands aren't Atomic</h3>
          <img src="images/interleaving-0.png" />
          <ul>
            <li>Scenario: Two clients want to increment <code>counter</code></li>
          </ul>
        </section>
        <section id="interleaving-1">
          <h3><em>Multiple</em> Commands aren't Atomic</h3>
          <img src="images/interleaving-1.png" />
          <ul>
            <li>Client #1 reads value of <code>counter</code></li>
          </ul>
        </section>
        <section id="interleaving-2">
          <h3><em>Multiple</em> Commands aren't Atomic</h3>
          <img src="images/interleaving-2.png" />
          <ul>
            <li>Client #2 reads value of <code>counter</code></li>
          </ul>
        </section>
        <section id="interleaving-3">
          <h3><em>Multiple</em> Commands aren't Atomic</h3>
          <img src="images/interleaving-3.png" />
          <ul>
            <li>Client #1 sets value of <code>counter</code> to <code>1</code></li>
          </ul>
        </section>
        <section id="interleaving-4">
          <h3><em>Multiple</em> Commands aren't Atomic</h3>
          <img src="images/interleaving-4.png" />
          <ul>
            <li>Client #2 sets value of <code>counter</code> to <code>1</code></li>
          </ul>
        </section>


        <section>
          <h3>Some use-cases have Atomic variants</h3>

          <pre><code class="ini">INCR foo # GET ; foo++ ; SET
SETNX bar # EXISTS bar ; SET bar
RPOPLPUSH src dest # RPOP ; LPUSH
GETSET key value # GET ; SET</code></pre>
        </section>


        <section id="interleaving-incr-0">
          <h3><code>INCR</code> is an Atomic Increment</h3>
          <img src="images/interleaving-incr-0.png" />
          <ul>
            <li>Scenario: Two clients want to increment <code>counter</code></li>
          </ul>
        </section>
        <section id="interleaving-incr-1">
          <h3><code>INCR</code> is an Atomic Increment</h3>
          <img src="images/interleaving-incr-1.png" />
          <ul>
            <li>Client #1 atomically increments value of <code>counter</code></li>
          </ul>
        </section>
        <section id="interleaving-incr-2">
          <h3><code>INCR</code> is an Atomic Increment</h3>
          <img src="images/interleaving-incr-2.png" />
          <ul>
            <li>Client #2 atomically increments value of <code>counter</code></li>
          </ul>
        </section>


        <section id="chapter-2">
          <h2>Pipelining</h2>
        </section>


        <section>
          <h3>Pipelining</h3>

          <ul>
            <li>Ensures commands are run in order per-connection</li>
            <li>Sends a batch of commands</li>
            <li>Commands are sent in the same message</li>
            <li><em>The <code>redis</code> module usually does this anyway</em></li>
          </ul>
        </section>


        <section>
          <h3>Pipelining: Example Code</h3>

          <pre><code class='javascript'>redis.batch()
  .zrangebyscore('jobs', 0, now) // get jobs
  .zremrangebyscore('jobs', 0, now) // delete jobs
  .exec((error, data) =&gt; {
    let jobList = data[0];
    console.log('jobs', jobList); // perform work
  });</code></pre>

          <pre><code class="ini">ZRANGEBYSCORE jobs 0 1553098369661
ZREMRANGEBYSCORE jobs 0 1553098369661</code></pre>
        </section>


        <section>
          <h3>Pipelining: Not True Atomicity</h3>

          <ul>
            <li>Other connections can still interleave commands</li>
            <li>A subset of commands can fail</li>
          </ul>
        </section>


        <section>
          <h3>Pipelining: What's it for?</h3>

          <ul>
            <li>Reducing network latency</li>
            <li>Send several commands in one message</li>
            <li>Receive several responses in one message</li>
          </ul>
        </section>


        <section id="chapter-3">
          <h2>Multi</h2>
        </section>


        <section>
          <h3>Multi: True Atomicity</h3>

          <ul>
            <li>Atomic across many clients / connections</li>
            <li>Client first sends a <code>MULTI</code> command</li>
            <li>Then, sends intermediary commands</li>
            <li>Intermediary commands don't run yet</li>
            <li>Other clients can run commands</li>
            <li>Client sends an <code>EXEC</code> command</li>
            <li>At this point the commands run</li>
          </ul>
        </section>


        <section>
          <h3>Multi: Transactional Atomicity</h3>

          <ul>
            <li><code>MULTI</code> begins a transaction</li>
            <li>Commands executed within are all-or-nothing</li>
            <li>Errors or disconnects won't lead to inconsistencies</li>
          </ul>
        </section>


        <section>
          <h3>Multi: Example Code</h3>

          <pre><code class='javascript'>redis.multi()
  .zrangebyscore('jobs', 0, now) // get jobs
  .zremrangebyscore('jobs', 0, now) // delete jobs
  .exec((error, data) =&gt; {
    let jobList = data[0];
    console.log('jobs', jobList); // perform work
  });</code></pre>

          <pre><code class="ini">MULTI
ZRANGEBYSCORE jobs 0 1553099335332
ZREMRANGEBYSCORE jobs 0 1553099335332
EXEC</code></pre>
        </section>
          </section>


        <section>
          <h3>Multi: No arg/return chaining</h3>

          <ul>
            <li>Can't use return values as arguments</li>
            <li>I.e., cannot pop from list, assign to new key</li>
          </ul>
        </section>


        <section id="chapter-4">
          <h2>Lua Scripting</h2>
        </section>


        <section>
          <h3>Lua: The Ultimate in Atomicity</h3>

          <ul>
            <li>Scripts need to be <code>LOAD</code>ed ahead of time</li>
            <li>Referenced by SHA1 sum</li>
            <li>Declare key names as arguments for sharding</li>
          </ul>
        </section>


        <section>
          <h3>Lua: Command Chaining</h3>

          <ul>
            <li>Output of one command <em>can</em> be piped into another</li>
            <li>Other processing can happen, too</li>
            <li>Similar to an RDBMS Stored Procedure</li>
          </ul>
        </section>


        <section>
          <h3>Lua: Example Code</h3>
          <!-- TODO: DIFFERENT EXAMPLE -->

          <pre><code class='lua'>-- get-cities.lua: Find cities within 10km of query

local key_geo = KEYS[1]
local key_hash = KEYS[2]
local lon = ARGV[1]
local lat = ARGV[2]

local city_ids = redis.call('GEORADIUS',
                            key_geo, lon, lat, 10, 'km')

return redis.call('HMGET', key_hash, unpack(city_ids))</code></pre>
        </section>

          <!-- TODO: JAVASCRIPT EXAMPLE -->

        <section>
          <h3>Lua: Drawbacks</h3>

          <ul>
            <li>Another language to maintain (simple grammar)</li>
            <li>Increases overhead on Redis server
              <ul>
                <li>An infinite loop would lock up server</li>
              </ul>
            </li>
            <li>Need to load scripts before using
              <ul>
                <li>It's idempotent; load scripts when app starts</li>
              </ul>
            </li>
          </ul>
        </section>


        <section>
          <h3>Intrinsic: Node.js Security Policies</h3>

<pre><code language="javascript">const REDIS = 'redis://redishost:6379/1';

routes.allRoutes(policy =&gt; {
  policy.redis.allowConnect(REDIS);
});

routes.get('/users/*', policy =&gt; {
  policy.redis.allowCommandKey(REDIS, 'GET', 'user-*');
});

routes.post('/server/stats', policy =&gt; {
  policy.redis.allowInfoSection(REDIS, 'memory');
});</code></pre>
        </section>



        <section id="final">
          <h3>Fin</h3>

          <ul>
            <li>Follow me: <code><a href="https://twitter.com/tlhunter">@tlhunter</a></code></li>
            <li>About Intrinsic: <code><a href="https://intrinsic.com">intrinsic.com</a></code></li>
            <li>This presentation: <code><a href="http://bit.ly/redis-atomicity">bit.ly/redis-atomicity</a></code></li>
          </ul>
        </section>


      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      Reveal.initialize({
        transition: 'none',
        center: true,
        touch: true,
        controls: false,
        controlsTutorial: false,
        controlsLayout: 'edges',
        controlsBackArrows: 'visible',
        history: true,
        help: false,
        dependencies: [
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
        ]
      });
    </script>
    <script type='text/javascript'>
      var Countly = {
        q: [['track_sessions'], ['track_pageview'], ['track_clicks']],
        app_key: 'eef3b12942f938d7be826186be17930bd522d315',
        url: 'https://analytics.phobosrising.co'
      };
      (function() {
         var cly = document.createElement('script'); cly.type = 'text/javascript';
         cly.async = true; cly.src = '/scripts/countly.min.js';
         cly.onload = function(){Countly.init()};
         var s = document.getElementsByTagName('script')[0];
         s.parentNode.insertBefore(cly, s);
      })();
    </script>
    <noscript><img src='https://analytics.phobosrising.co/pixel.png?app_key=d91922f2a4106e3f1b2851a7bc4852606a289177&begin_session=1'/></noscript>
  </body>
</html>
